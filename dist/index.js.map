{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import path from 'node:path';\nimport {readFile,glob} from 'node:fs/promises';\nimport * as vscode from 'vscode';\ninterface Runner {\n  relative_filename: string;\n  full_filename: string;\n  run_dir: string; // same as full_filename, except trims last leg if it is '/bin'\n}\n\nasync function get_sub_workspaces(folder:string){\n  try{\n    const file_name=path.join(folder,'package.json')\n    const content=await readFile(file_name,'utf8')\n    const {workspaces} = JSON.parse(content);\n    if (!Array.isArray(workspaces))\n      return []\n    return workspaces.filter(x=>typeof x==='string').map(x=>path.join(folder,x))\n  }catch(_ex:unknown){\n    return []\n  }\n}\nfunction getCommonPrefix(paths: string[]): string {\n  if (paths.length === 0) return \"\";\n  if (paths.length === 1) return paths[0];\n\n  // Split each path into parts (e.g., by \"/\" or \"\\\\\")\n  const splitPaths = paths.map(p => p.split(/[\\\\/]+/));\n\n  const commonParts: string[] = [];\n  const first = splitPaths[0];\n\n  for (let i = 0; i < first.length; i++) {\n    const part = first[i];\n    if (splitPaths.every(p => p[i] === part)) {\n      commonParts.push(part);\n    } else {\n      break;\n    }\n  }\n\n  // Join back with \"/\" (or use path.join for platform-specific behavior)\n  return commonParts.join(\"/\");\n}\nasync function get_dirs(top_workspaces:string[]){\n  const dirs=new Set<string>\n  for (const top_workspace of top_workspaces){\n    const normalized=path.normalize(top_workspace)\n    dirs.add(normalized)\n    for (const sub of await get_sub_workspaces(normalized)){\n      dirs.add(path.normalize(sub))\n    }\n  }\n  return [...dirs]\n}\n\nasync function get_runners(top_workspaces:string[]){\n  const ans:Runner[]=[]\n  const common=getCommonPrefix(top_workspaces)  \n  const dirs=await get_dirs(top_workspaces)\n  for (const run_dir of dirs){\n    for (const base of ['','bin']){\n      const glob_pat=path.join(run_dir,base,'watch_*.{ts,js,mjs}')\n      console.log(glob_pat)\n      for await (const full_filename of glob(glob_pat)) {\n        console.log(full_filename)\n        const relative_filename=path.relative(common,full_filename)\n        ans.push({relative_filename,full_filename,run_dir})\n\n      }\n    }\n  }\n  return ans\n}\nfunction run_runner(runner:Runner){\n  const name=runner.relative_filename\n  const term = vscode.window.createTerminal({ name });\n  term.sendText(`cd ${runner.run_dir}`);\n  term.sendText(`node ${runner.full_filename}`);\n}\n\nfunction run_runners(runners:Runner[]){\n  const exists=new Set<string>\n  for (const term of vscode.window.terminals){\n    exists.add(term.name)\n  }\n  for (const runner of runners){\n    if (!exists.has(runner.relative_filename)){\n      run_runner(runner)\n\n    }\n  }\n \n}\n\nexport function activate(context: vscode.ExtensionContext) {\n  // Use the console to output diagnostic information (console.log) and errors (console.error)\n  // This line of code will only be executed once when your extension is activated\n  console.log('Congratulations, your extension \"helloworld-sample\" is now active!');\n\n  // The command has been defined in the package.json file\n  // Now provide the implementation of the command with registerCommand\n  // The commandId parameter must match the command field in package.json\n      const outputChannel = vscode.window.createOutputChannel(\"aaaWatchRunner\");  \n    vscode.tasks.onDidEndTaskProcess((event) => {\n      const task = event.execution.task;\n      const exitCode = event.exitCode;\n      outputChannel.append(JSON.stringify(event,null,2))\n    })\n    const disposable = vscode.commands.registerCommand('WatchRunner.run',async  () => {\n\n      const {workspaceFolders}=vscode.workspace\n      const folders=/*['c:\\\\yigal\\\\watch_runner_extension']//*/(workspaceFolders||[]).map(x=>x.uri.fsPath)\n      const runners=await get_runners(folders)\n      run_runners(runners)\n      outputChannel.append(JSON.stringify({runners,folders},null,2))\n  });\n\n  context.subscriptions.push(disposable);\n}\n\n// this method is called when your extension is deactivated\nexport function deactivate() {}\n\n"],
  "mappings": "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",
  "names": []
}
